# äº”æ–¤é”ï¼ˆ@synchronizedï¼‰åŸç†æ€»ç»“

## ğŸ”’ æ ¸å¿ƒåŸç†

**æ¯ä¸€ä¸ª Objective-C å¯¹è±¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªéšå«çš„é”å˜é‡**ï¼ˆç±»ä¼¼äºäºŒè¿›åˆ¶ä¿¡å·é‡ï¼‰ï¼Œç”¨äºå®ç°çº¿ç¨‹åŒæ­¥ã€‚

## ğŸ¯ å·¥ä½œåŸç†ï¼ˆ5ä¸ªæ­¥éª¤ï¼‰

```mermaid
graph TD
    A[çº¿ç¨‹åˆ°è¾¾ synchronized] --> B{æ£€æŸ¥é”çŠ¶æ€};
    B -->|å¼€é”çŠ¶æ€ 1| C[ä¸Šé” 0];
    B -->|å·²ä¸Šé” 0| D[çº¿ç¨‹ç­‰å¾…];
    C --> E[æ‰§è¡Œä»£ç å—];
    E --> F[æ‰§è¡Œå®Œæ¯• å¼€é” 1];
    D --> B;
```

### è¯¦ç»†æµç¨‹ï¼š
1. **æ£€æŸ¥é”çŠ¶æ€**ï¼šçº¿ç¨‹è¿›å…¥ `@synchronized(obj)` æ—¶ï¼Œæ£€æŸ¥ `obj` çš„é”çŠ¶æ€
2. **åˆ¤æ–­æ¡ä»¶**ï¼š
   - å¦‚æœé”æ˜¯ **å¼€é”çŠ¶æ€ (1)** â†’ è¿›å…¥æ­¥éª¤3
   - å¦‚æœé”æ˜¯ **ä¸Šé”çŠ¶æ€ (0)** â†’ è¿›å…¥æ­¥éª¤5
3. **ä¸Šé”**ï¼šå°†é”çŠ¶æ€è®¾ä¸º **0**ï¼ˆä¸Šé”ï¼‰
4. **æ‰§è¡Œä»£ç **ï¼šæ‰§è¡Œ synchronized ä»£ç å—å†…çš„é€»è¾‘
5. **å¼€é”**ï¼šä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼Œå°†é”çŠ¶æ€æ¢å¤ä¸º **1**ï¼ˆå¼€é”ï¼‰
6. **çº¿ç¨‹ç­‰å¾…**ï¼šå¦‚æœé”å·²è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥**å°±ç»ªçŠ¶æ€**ç­‰å¾…

## ğŸ“ ä»£ç ç¤ºä¾‹

```objective-c
// ä½¿ç”¨ @synchronized
@synchronized(self) {
    // è¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ä»£ç åŒºåŸŸ
    self.sharedData = [self processData];
    [self updateCount];
}
```

## âš–ï¸ ä¼˜ç¼ºç‚¹åˆ†æ

### âœ… ä¼˜ç‚¹ï¼š
1. **ç®€å•æ˜“ç”¨**ï¼šè¯­æ³•ç®€æ´ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†é”
2. **è‡ªåŠ¨ç®¡ç†**ï¼šè‡ªåŠ¨åŠ é”/è§£é”ï¼Œé¿å…æ­»é”
3. **å¯¹è±¡çº§é”**ï¼šä¸åŒå¯¹è±¡å¯ä½¿ç”¨ä¸åŒé”ï¼Œæé«˜å¹¶å‘æ€§
4. **å¼‚å¸¸å®‰å…¨**ï¼šå³ä½¿ä»£ç å—æŠ›å‡ºå¼‚å¸¸ï¼Œé”ä¹Ÿä¼šæ­£ç¡®é‡Šæ”¾

### âŒ ç¼ºç‚¹ï¼š
1. **æ€§èƒ½å¼€é”€**ï¼šæ£€æŸ¥é”çŠ¶æ€ã€çº¿ç¨‹ç­‰å¾…å¢åŠ é¢å¤–å¼€é”€
2. **æ•ˆç‡é™ä½**ï¼šä¸²è¡Œæ‰§è¡Œä»£ç å—ï¼Œé™ä½å¹¶å‘æ€§èƒ½
3. **å¯èƒ½æ­»é”**ï¼šä¸å½“çš„åµŒå¥—ä½¿ç”¨å¯èƒ½å¯¼è‡´æ­»é”
```objective-c
// é”™è¯¯ç¤ºä¾‹ï¼šå¯èƒ½æ­»é”
@synchronized(objA) {
    @synchronized(objB) {
        // å¦‚æœå¦ä¸€çº¿ç¨‹å…ˆé” objB å†é” objAï¼Œå¯èƒ½æ­»é”
    }
}
```

## ğŸ”§ åº•å±‚å®ç°

### å®é™…æ˜¯è½¬æ¢ä¸ºï¼š
```objective-c
// @synchronized(obj) { ... } å®é™…ä¸Šè½¬æ¢ä¸ºï¼š
objc_sync_enter(obj);
// ä»£ç å—...
objc_sync_exit(obj);
```

### é”çš„æ•°æ®ç»“æ„ï¼š
```c
typedef struct {
    id object;          // è¢«é”çš„å¯¹è±¡
    int threadCount;    // ç­‰å¾…çº¿ç¨‹æ•°
    // å…¶ä»–åŒæ­¥ä¿¡æ¯...
} SyncData;
```

## ğŸª ä½¿ç”¨åœºæ™¯å¯¹æ¯”

| åœºæ™¯ | æ˜¯å¦ä½¿ç”¨ @synchronized | ç†ç”± |
|------|----------------------|------|
| ç®€å•æ•°æ®ä¿æŠ¤ | âœ… æ¨è | ä»£ç ç®€æ´ï¼Œå®‰å…¨ |
| é«˜æ€§èƒ½å¹¶å‘ | âŒ ä¸æ¨è | æ€§èƒ½å¼€é”€å¤§ |
| å¤æ‚é”é€»è¾‘ | âŒ ä¸æ¨è | åŠŸèƒ½æœ‰é™ |
| iOS UIæ›´æ–° | âŒ ä¸æ¨è | åº”ä½¿ç”¨ dispatch_async(ä¸»é˜Ÿåˆ—) |

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. **é€‰æ‹©æ­£ç¡®çš„é”å¯¹è±¡**
```objective-c
// æ­£ç¡®ï¼šä¸ºç‰¹å®šæ•°æ®åˆ›å»ºä¸“ç”¨é”å¯¹è±¡
@property (nonatomic, strong) NSObject *dataLock;

- (instancetype)init {
    if (self = [super init]) {
        _dataLock = [[NSObject alloc] init];  // ä¸“ç”¨é”å¯¹è±¡
        _sharedData = [NSMutableArray array];
    }
    return self;
}

- (void)addItem:(id)item {
    @synchronized(self.dataLock) {  // ä½¿ç”¨ä¸“ç”¨é”
        [self.sharedData addObject:item];
    }
}
```

### 2. **é¿å…é”åµŒå¥—**
```objective-c
// é¿å…è¿™æ ·
- (void)unsafeMethod {
    @synchronized(self) {
        // ä¸€äº›æ“ä½œ...
        [self anotherMethod];  // å¯èƒ½åŒ…å«å¦ä¸€ä¸ª @synchronized(self)
    }
}

- (void)anotherMethod {
    @synchronized(self) {  // å±é™©ï¼šå¯èƒ½é€’å½’é”æˆ–æ­»é”
        // ...
    }
}
```

### 3. **é”çš„èŒƒå›´æœ€å°åŒ–**
```objective-c
// ä¸å¥½ï¼šé”èŒƒå›´å¤ªå¤§
@synchronized(self) {
    id result = [self fetchFromDatabase];  // è€—æ—¶æ“ä½œ
    [self processResult:result];           // å¤„ç†æ•°æ®
    self.displayText = result.description; // æ›´æ–°å±æ€§
}

// å¥½ï¼šåªé”å¿…è¦çš„éƒ¨åˆ†
id result = [self fetchFromDatabase];  // æ— é”æ“ä½œï¼ˆå¦‚æœä¸æ¶‰åŠå…±äº«æ•°æ®ï¼‰
@synchronized(self) {
    [self.sharedArray addObject:result];  // åªé”å…±äº«æ•°æ®è®¿é—®
}
dispatch_async(dispatch_get_main_queue(), ^{
    self.displayText = result.description;  // UIæ›´æ–°åœ¨ä¸»çº¿ç¨‹
});
```

## ğŸ†š ä¸å…¶ä»–é”æœºåˆ¶å¯¹æ¯”

| é”ç±»å‹ | å¤æ‚åº¦ | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|--------|--------|------|----------|
| `@synchronized` | â­ ç®€å• | â­â­ ä¸€èˆ¬ | ç®€å•åŒæ­¥ |
| `NSLock` | â­â­ ä¸­ç­‰ | â­â­â­ è¾ƒå¥½ | ä¸€èˆ¬åŒæ­¥ |
| `dispatch_semaphore` | â­â­â­ è¾ƒå¤æ‚ | â­â­â­â­ å¥½ | èµ„æºè®¡æ•° |
| `pthread_mutex` | â­â­â­â­ å¤æ‚ | â­â­â­â­â­ ä¼˜ç§€ | é«˜æ€§èƒ½éœ€æ±‚ |
| `OSSpinLock` | â­â­ ä¸­ç­‰ | â­â­â­â­â­ æå¥½ | iOS 10å‰é«˜æ€§èƒ½ |

## ğŸ“Š æ€§èƒ½å½±å“æ•°æ®

| æ“ä½œ | å¤§æ¦‚è€—æ—¶ | è¯´æ˜ |
|------|----------|------|
| æ— é”è®¿é—® | ~0.001ms | åŸºç¡€å†…å­˜è®¿é—® |
| `@synchronized` åŠ é” | ~0.05ms | æ£€æŸ¥é”çŠ¶æ€ã€çº¿ç¨‹åˆ‡æ¢ |
| çº¿ç¨‹ç­‰å¾… | 0.1ms-âˆ | å–å†³äºå…¶ä»–çº¿ç¨‹æ‰§è¡Œæ—¶é—´ |
| é”ç«äº‰ä¸¥é‡æ—¶ | æ€§èƒ½ä¸‹é™ 50-80% | å¤šä¸ªçº¿ç¨‹é¢‘ç¹äº‰æŠ¢åŒä¸€é” |

## ğŸš€ ç°ä»£æ›¿ä»£æ–¹æ¡ˆ

### ä½¿ç”¨ GCD é˜Ÿåˆ—æ›¿ä»£ï¼š
```objective-c
// åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—ç”¨äºåŒæ­¥
@property (nonatomic, strong) dispatch_queue_t syncQueue;

- (instancetype)init {
    if (self = [super init]) {
        _syncQueue = dispatch_queue_create("com.example.sync", DISPATCH_QUEUE_SERIAL);
        _sharedData = [NSMutableArray array];
    }
    return self;
}

- (void)addItem:(id)item {
    dispatch_sync(self.syncQueue, ^{
        [self.sharedData addObject:item];
    });
}
```

## ğŸ“ å…³é”®è®°å¿†ç‚¹

1. **"äº”æ–¤"** = "ç‰©é•œ" â†’ æ¯ä¸ª**å¯¹è±¡**éƒ½æœ‰é”
2. **äºŒè¿›åˆ¶çŠ¶æ€**ï¼š1=å¼€é”ï¼ˆå¯è¿›å…¥ï¼‰ï¼Œ0=ä¸Šé”ï¼ˆéœ€ç­‰å¾…ï¼‰
3. **è‡ªåŠ¨ç®¡ç†**ï¼šè¿›å…¥è‡ªåŠ¨ä¸Šé”ï¼Œé€€å‡ºè‡ªåŠ¨å¼€é”
4. **æ€§èƒ½ä»£ä»·**ï¼šå®‰å…¨ vs æ•ˆç‡çš„æƒè¡¡
5. **ç°ä»£å¼€å‘**ï¼šä¼˜å…ˆè€ƒè™‘ GCD/NSOperation

## âš ï¸ å¸¸è§é”™è¯¯

```objective-c
// é”™è¯¯1ï¼šé” nil å¯¹è±¡ï¼ˆæ— æ•ˆï¼‰
@synchronized(nil) {  // å¯¹ nil åŠ é”æ— æ•ˆï¼
    // è¿™é‡Œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
}

// é”™è¯¯2ï¼šé¢‘ç¹å°æ“ä½œåŠ é”ï¼ˆæ€§èƒ½å·®ï¼‰
for (int i = 0; i < 1000; i++) {
    @synchronized(self) {  // 1000æ¬¡åŠ é”/è§£é”ï¼
        [self.array addObject:@(i)];
    }
}

// æ­£ç¡®ï¼šæ‰¹é‡æ“ä½œä¸€æ¬¡åŠ é”
@synchronized(self) {
    for (int i = 0; i < 1000; i++) {
        [self.array addObject:@(i)];
    }
}
```

**æ€»ç»“**ï¼š`@synchronized` æ˜¯ Objective-C ä¸­æœ€ç®€å•æ˜“ç”¨çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼Œé€‚åˆä¿æŠ¤å°æ®µå…³é”®ä»£ç ï¼Œä½†åœ¨é«˜æ€§èƒ½åœºæ™¯åº”è€ƒè™‘æ›´é«˜æ•ˆçš„æ›¿ä»£æ–¹æ¡ˆã€‚